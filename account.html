<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body class="admin-dark">
  <h1>–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</h1>
  <a href="index.html" class="back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a><br>
  <div id="account-info" style="margin:18px 0 24px 0;padding:18px 22px;border-radius:12px;background:#f8fdfd;max-width:420px;box-shadow:0 2px 12px #0001;">
    <div id="tg-user-block">
      <b>Telegram ID:</b> <span id="tg-id">‚Äî</span><br>
      <b>–ò–º—è:</b> <span id="tg-name">‚Äî</span>
    </div>
    <div id="account-status" style="margin-top:10px;color:#00916e;font-weight:600;"></div>
    <div id="balance-block" style="margin-top:18px;text-align:right;display:none;"></div>
  </div>
  <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="toast" style="display:none;position:fixed;left:50%;bottom:32px;transform:translateX(-50%);background:#222;color:#fff;padding:14px 28px;border-radius:12px;font-size:1.08em;z-index:2000;box-shadow:0 4px 24px #0005;opacity:0.97;transition:opacity 0.3s;"></div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
  <div id="topup-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:18px;box-shadow:0 8px 32px #0003;max-width:340px;width:90vw;position:relative;">
      <button id="topup-close" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.3em;color:#bbb;cursor:pointer;">√ó</button>
      <h2 style="margin:0 0 18px 0;font-size:1.2em;color:#00916e;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
      <label for="topup-amount" style="color:#444;font-size:1em;">–°—É–º–º–∞ (‚ÇΩ):</label>
      <input id="topup-amount" type="number" min="1" step="1" style="width:100%;margin:10px 0 12px 0;padding:10px 12px;border-radius:8px;border:1px solid #eee;font-size:1.1em;" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />
      <label for="topup-system" style="color:#444;font-size:1em;">–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</label>
      <select id="topup-system" style="width:100%;margin:10px 0 12px 0;padding:8px 10px;border-radius:8px;border:1px solid #eee;font-size:1.05em;">
        <option value="yookassa">–ÆKassa</option>
        <option value="cloudpayments">CloudPayments</option>
      </select>
      <div id="topup-error" style="color:#e74c3c;font-size:0.98em;min-height:20px;margin-bottom:8px;"></div>
      <button id="topup-confirm" style="width:100%;padding:12px 0;border-radius:10px;background:#f9b32b;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.08em;">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button id="topup-check" style="width:100%;padding:10px 0;border-radius:10px;background:#00916e;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.02em;margin-top:10px;display:none;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    </div>
  </div>
  <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π</h2>
  <div id="history-list" style="margin-bottom:24px;">‚Äî</div>
  <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
  <div id="favorites-list">‚Äî</div>
  <script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Telegram WebApp API
  function getTelegramUser() {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
      return window.Telegram.WebApp.initDataUnsafe.user;
    }
    return null;
  }

  function showAccountInfo(user) {
    document.getElementById('tg-id').textContent = user.id;
    document.getElementById('tg-name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    document.getElementById('account-status').textContent = '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω';
  }

  function createAccountIfNeeded(user) {
    // –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
    fetch('https://store-backend-zpkh.onrender.com/account', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegram_id: user.id,
        name: user.first_name + (user.last_name ? ' ' + user.last_name : '')
      })
    })
    .then(res => res.json())
    .then(data => {
      // –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
      loadHistory(user.id);
      loadFavorites(user.id);
    })
    .catch(() => {
      document.getElementById('account-status').textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞';
    });
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString().slice(0,5);
  }
  async function loadHistory(telegramId) {
    const list = document.getElementById('history-list');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/account/' + telegramId + '/history');
      const data = await res.json();
      if (data && data.length) {
        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
        const productsRes = await fetch('https://store-backend-zpkh.onrender.com/products');
        const products = await productsRes.json();
        list.innerHTML = data.reverse().map(item => {
          const prod = products.find(p=>p.id===item.productId);
          if (!prod) return '';
          const imageUrl = prod.image ? `images/${prod.image}` : 'images/placeholder.png';
          const ext = prod.file ? prod.file.split('.').pop().toLowerCase() : '';
          let icon = '';
          if (["pdf"].includes(ext)) icon = 'üìÑ';
          else if (["zip","rar","7z"].includes(ext)) icon = 'üóúÔ∏è';
          else if (["doc","docx","txt","rtf"].includes(ext)) icon = 'üìù';
          else if (["xls","xlsx","csv"].includes(ext)) icon = 'üìä';
          else if (["png","jpg","jpeg","gif","bmp","webp"].includes(ext)) icon = 'üñºÔ∏è';
          else if (["blend","obj","fbx","stl"].includes(ext)) icon = 'üß©';
          else icon = 'üì¶';
          let extra = '';
          if (!item.expired && item.daysLeft <= 2) extra = `<div style=\"color:#e67e22;font-size:0.97em;\">–í–Ω–∏–º–∞–Ω–∏–µ: –¥–æ—Å—Ç—É–ø –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${item.daysLeft} ${item.daysLeft===1?'–¥–µ–Ω—å':'–¥–Ω—è'}!</div>`;
          if (item.expired) extra = '<div style="color:#aaa;font-size:0.97em;">–î–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫. <a href="product.html?id='+prod.id+'" style="color:#00916e;text-decoration:underline;">–ö—É–ø–∏—Ç—å —Å–Ω–æ–≤–∞</a></div>';
          return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:${item.expired?'#f4f4f4':'#fff'};padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;opacity:${item.expired?'0.6':'1'};">
            <img src="images/${prod.image ? prod.image : 'placeholder.png'}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;filter:${item.expired?'grayscale(1)':''};">
            <div style="flex:1;">
              <b>${prod.name}</b><br>
              <span style="color:#888;font-size:0.98em;">${icon} ${prod.file ? prod.file.split('/').pop() : ''}</span><br>
              <span style="color:#43e97b;font-size:0.97em;">${formatDate(item.date)}</span>
              ${extra}
            </div>
            <a href="product.html?id=${prod.id}" style="color:#00916e;font-size:1.3em;margin-right:8px;" title="–ö —Ç–æ–≤–∞—Ä—É">üîé</a>
            ${prod.file && !item.expired ? `<button onclick="downloadFile('${prod.id}')" style="background:#00916e;color:#fff;border:none;border-radius:8px;padding:7px 13px;cursor:pointer;font-size:1em;">‚¨áÔ∏è</button>` : ''}
          </div>`;
        }).join('') + '<div style="color:#888;font-size:0.98em;margin-top:8px;">* –î–æ—Å—Ç—É–ø –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –æ—Ç–∫—Ä—ã—Ç 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏</div>';
      } else {
        list.innerHTML = '<div style="color:#888;text-align:center;">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –∏–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π.</div>';
      }
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.';
    }
  }
  async function downloadFile(productId) {
    if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram'); return;
    }
    const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
    const resp = await fetch('https://store-backend-zpkh.onrender.com/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: telegramId, productId })
    });
    const data = await resp.json();
    if (resp.ok && data.url) {
      const link = document.createElement('a');
      link.href = data.url;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
    }
  }
  async function loadFavorites(telegramId) {
    const list = document.getElementById('favorites-list');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/account/' + telegramId + '/favorites');
      const data = await res.json();
      if (data && data.length) {
        list.innerHTML = data.map(prod => {
          const imageUrl = prod.image ? `images/${prod.image}` : 'images/placeholder.png';
          const ext = prod.file ? prod.file.split('.').pop().toLowerCase() : '';
          let icon = '';
          if (["pdf"].includes(ext)) icon = 'üìÑ';
          else if (["zip","rar","7z"].includes(ext)) icon = 'üóúÔ∏è';
          else if (["doc","docx","txt","rtf"].includes(ext)) icon = 'üìù';
          else if (["xls","xlsx","csv"].includes(ext)) icon = 'üìä';
          else if (["png","jpg","jpeg","gif","bmp","webp"].includes(ext)) icon = 'üñºÔ∏è';
          else if (["blend","obj","fbx","stl"].includes(ext)) icon = 'üß©';
          else icon = 'üì¶';
          return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:#fff;padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;">
            <img src="${imageUrl}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;">
            <div style="flex:1;">
              <b>${prod.name}</b><br>
              <span style="color:#888;font-size:0.98em;">${icon} ${prod.file ? prod.file.split('/').pop() : ''}</span>
            </div>
            <a href="product.html?id=${prod.id}" style="color:#00916e;font-size:1.3em;margin-right:8px;" title="–ö —Ç–æ–≤–∞—Ä—É">üîé</a>
            ${prod.file ? `<button onclick="downloadFile('${prod.id}')" style="background:#00916e;color:#fff;border:none;border-radius:8px;padding:7px 13px;cursor:pointer;font-size:1em;">‚¨áÔ∏è</button>` : ''}
          </div>`;
        }).join('');
      } else {
        list.textContent = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.';
      }
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.';
    }
  }
  function showToast(msg, color) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.background = color || '#222';
    toast.style.display = 'block';
    toast.style.opacity = '0.97';
    setTimeout(()=>{ toast.style.opacity = '0'; }, 2200);
    setTimeout(()=>{ toast.style.display = 'none'; }, 2600);
  }
  let lastBalance = null;
  async function updateBalance(telegramId, showToastOnChange) {
    const balanceBlock = document.getElementById('balance-block');
    if (!telegramId) return;
    try {
      const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/balance`);
      const data = await resp.json();
      if (resp.ok) {
        balanceBlock.style.display = '';
        balanceBlock.innerHTML = `<span style='color:#f9b32b;font-weight:600;'>–ë–∞–ª–∞–Ω—Å: </span><span id='balance-value' style='color:#222;font-weight:700;'>${data.balance.toLocaleString()} ‚ÇΩ</span> <button id='topup-btn' style='margin-left:8px;padding:4px 12px;border-radius:8px;background:#fff;color:#f9b32b;border:1px solid #f9b32b;cursor:pointer;font-size:0.98em;'>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>`;
        if (lastBalance !== null && data.balance !== lastBalance && showToastOnChange) {
          showToast('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω!', '#43e97b');
        }
        lastBalance = data.balance;
        document.getElementById('topup-btn').onclick = function() {
          document.getElementById('topup-modal').style.display = 'flex';
          document.getElementById('topup-amount').value = '';
          document.getElementById('topup-error').textContent = '';
          document.getElementById('topup-check').style.display = 'none';
        };
        document.getElementById('topup-close').onclick = function() {
          document.getElementById('topup-modal').style.display = 'none';
        };
        document.getElementById('topup-check').onclick = function() {
          updateBalance(telegramId, true);
        };
        document.getElementById('topup-confirm').onclick = async function() {
          const sum = document.getElementById('topup-amount').value.trim();
          const amount = Number(sum);
          const system = document.getElementById('topup-system').value;
          const errorDiv = document.getElementById('topup-error');
          if (!amount || isNaN(amount) || amount <= 0) {
            errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É';
            return;
          }
          errorDiv.textContent = '';
          document.getElementById('topup-confirm').disabled = true;
          document.getElementById('topup-confirm').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';
          try {
            const resp = await fetch(`https://store-backend-zpkh.onrender.com/create_payment_link`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount, telegramId, system })
            });
            const data = await resp.json();
            if (resp.ok && data.url) {
              window.open(data.url, '_blank');
              document.getElementById('topup-modal').style.display = 'flex';
              document.getElementById('topup-check').style.display = '';
              showToast('–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å"', '#f9b32b');
            } else {
              errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞';
            }
          } catch {
            errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
          }
          document.getElementById('topup-confirm').disabled = false;
          document.getElementById('topup-confirm').textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å';
        };
      }
    } catch {}
  }

  window.addEventListener('DOMContentLoaded', function() {
    const user = getTelegramUser();
    if (user) {
      showAccountInfo(user);
      createAccountIfNeeded(user);
      updateBalance(user.id);
      // Polling –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
      let pollInterval = null;
      document.getElementById('topup-modal').addEventListener('transitionstart', function() {
        if (this.style.display === 'flex') {
          pollInterval = setInterval(()=>updateBalance(user.id, true), 7000);
        } else {
          clearInterval(pollInterval);
        }
      });
    } else {
      document.getElementById('account-status').textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.';
    }
  });
  </script>
</body>
</html>
