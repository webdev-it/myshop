<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Интернет-магазин</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body>
  <header style="position:relative;">
    <h1>Мой Интернет-Магазин</h1>
    <div id="welcome">Здравствуйте, гость!</div>
    <div id="balance-block" style="float:right;margin-top:8px;margin-right:8px;display:none;"></div>
    <a href="#" class="back" onclick="goToPage('index.html'); return false;">← На главную</a>
    <a id="profile-link" href="#" style="display:none;position:absolute;top:16px;right:16px;text-decoration:none;" onclick="goToPage('account.html'); return false;">
      <div id="profile-avatar" style="width:44px;height:44px;border-radius:50%;overflow:hidden;box-shadow:0 2px 8px #0002;background:#e0f7fa;display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:700;color:#00916e;"></div>
    </a>
  </header>

  <main>
    <section class="intro">
      <h2>Добро пожаловать!</h2>
      <p>Выберите категорию товаров выше, чтобы начать покупки.</p>
    </section>
    <div class="filters" style="margin:18px 0 10px 0;display:flex;flex-direction:column;gap:8px;align-items:center;max-width:440px;width:100%;margin-left:auto;margin-right:auto;">
      <div style="width:100%;display:flex;justify-content:center;align-items:center;">
        <input type="text" id="search-input" placeholder="Поиск по названию..." style="padding:10px 16px;border-radius:10px;border:1.5px solid #e0f7fa;font-size:15px;min-width:160px;width:100%;max-width:440px;box-sizing:border-box;background:#f8fdfd;outline:none;height:48px;">
      </div>
      <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;width:100%;max-width:440px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span title="Категория" style="display:inline-flex;align-items:center;"><svg width="18" height="18" style="margin-right:3px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="#00916e" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></span>
          <select id="category-filter" style="padding:9px 14px;border-radius:9px;border:1.5px solid #e0f7fa;min-width:110px;font-size:14px;background:#f8fdfd;outline:none;height:48px;">
            <option value="">Все категории</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span title="Сортировка" style="display:inline-flex;align-items:center;"><svg width="18" height="18" style="margin-right:3px;vertical-align:middle;" viewBox="0 0 24 24"><path fill="#00916e" d="M3 18h6v-2H3v2zm0-5h12v-2H3v2zm0-7v2h18V6H3z"/></svg></span>
          <select id="sort-select" style="padding:9px 14px;border-radius:9px;border:1.5px solid #e0f7fa;min-width:110px;font-size:14px;background:#f8fdfd;outline:none;height:48px;">
            <option value="">Сортировка</option>
            <option value="price-asc">Цена ↑</option>
            <option value="price-desc">Цена ↓</option>
            <option value="name-asc">Название A-Я</option>
            <option value="name-desc">Название Я-А</option>
          </select>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;">
          <label style="display:flex;align-items:center;gap:8px;border:2px solid #43e97b;border-radius:12px;padding:4px 14px 4px 10px;cursor:pointer;background:#f8fdfd;user-select:none;">
            <span style="font-size:13px;color:#00916e;font-weight:600;">Бесплатно</span>
            <span style="position:relative;display:inline-block;width:38px;height:24px;">
              <input type="checkbox" id="free-filter" style="opacity:0;width:38px;height:24px;margin:0;position:absolute;left:0;top:0;z-index:2;cursor:pointer;">
              <span style="position:absolute;left:0;top:0;width:38px;height:24px;background:#e0f7fa;border-radius:12px;transition:.2s;"></span>
              <span style="position:absolute;top:3px;left:3px;width:18px;height:18px;background:#43e97b;border-radius:50%;transition:.2s;"></span>
            </span>
          </label>
        </div>
      </div>
    </div>
    <div class="products" id="product-list"></div>
    <nav>
      <ul id="category-list">
        <li>Загрузка категорий...</li>
      </ul>
    </nav>
  </main>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user;
    if (user) {
      document.getElementById("welcome").textContent = `Здравствуйте, ${user.first_name}!`;
      // Баланс
      const balanceBlock = document.getElementById('balance-block');
      async function updateBalance() {
        try {
          const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${user.id}/balance`);
          const data = await resp.json();
          if (resp.ok) {
            balanceBlock.style.display = '';
            balanceBlock.innerHTML = `<span style='color:#f9b32b;font-weight:600;'>Баланс: </span><span style='color:#222;font-weight:700;'>${data.balance.toLocaleString()} ₽</span> <button id='topup-btn' style='margin-left:8px;padding:4px 12px;border-radius:8px;background:#fff;color:#f9b32b;border:1px solid #f9b32b;cursor:pointer;font-size:0.98em;'>Пополнить</button>`;
            document.getElementById('topup-btn').onclick = async function() {
              const sum = prompt('Введите сумму для пополнения (₽):');
              const amount = Number(sum);
              if (!amount || isNaN(amount) || amount <= 0) return alert('Некорректная сумма');
              const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${user.id}/balance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
              });
              const data = await resp.json();
              if (resp.ok) {
                alert('Баланс успешно пополнен!');
                updateBalance();
              } else {
                alert(data.error || 'Ошибка пополнения');
              }
            };
          }
        } catch {}
      }
      updateBalance();
      // --- Профиль ---
      const profileLink = document.getElementById('profile-link');
      const profileAvatar = document.getElementById('profile-avatar');
      if (user.photo_url) {
        profileAvatar.innerHTML = `<img src="${user.photo_url}" alt="avatar" style="width:100%;height:100%;object-fit:cover;">`;
      } else {
        let initials = user.first_name ? user.first_name[0] : '';
        if (user.last_name) initials += user.last_name[0];
        profileAvatar.textContent = initials.toUpperCase();
      }
      profileLink.style.display = '';
    }
  </script>
  <script>
  const API_CATEGORIES = "https://store-backend-zpkh.onrender.com/categories";
  const API_PRODUCTS = "https://store-backend-zpkh.onrender.com/products";

  let allCategories = [];
  let allProducts = [];

  async function loadCategories() {
    try {
      const res = await fetch(API_CATEGORIES);
      if (!res.ok) throw new Error("Ошибка загрузки категорий");
      allCategories = await res.json();
      // Для фильтра
      const select = document.getElementById('category-filter');
      select.innerHTML = '<option value="">Все категории</option>';
      allCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
      });
      // Для перехода по категориям
      const ul = document.getElementById("category-list");
      ul.innerHTML = "";
      allCategories.forEach(cat => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="#" onclick=\"goToPage('category.html?id=${cat.id}'); return false;\">${cat.name}</a>`;
        ul.appendChild(li);
      });
    } catch (err) {
      document.getElementById("category-list").innerHTML = "<li>Ошибка загрузки категорий</li>";
    }
  }

  async function loadProducts() {
    const res = await fetch(API_PRODUCTS);
    allProducts = await res.json();
  }

  function filterAndRender() {
    const search = document.getElementById('search-input').value.trim().toLowerCase();
    const catId = document.getElementById('category-filter').value;
    const sort = document.getElementById('sort-select').value;
    const freeOnly = document.getElementById('free-filter').checked;
    // Если не выбран фильтр категории, не введён поисковый запрос и не включён чекбокс бесплатных — не показываем товары
    if (!catId && !search && !freeOnly) {
      renderProducts([], true);
      return;
    }
    let filtered = allProducts.slice();
    if (catId) filtered = filtered.filter(p => p.category === catId);
    if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
    if (freeOnly) filtered = filtered.filter(p => p.price === 0);
    if (sort === 'price-asc') filtered.sort((a,b)=>a.price-b.price);
    if (sort === 'price-desc') filtered.sort((a,b)=>b.price-a.price);
    if (sort === 'name-asc') filtered.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
    if (sort === 'name-desc') filtered.sort((a,b)=>b.name.localeCompare(a.name,'ru'));
    renderProducts(filtered);
  }

  function renderProducts(products, showPlaceholder) {
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    if (showPlaceholder) {
      list.innerHTML = '<div style="color:#888;padding:30px 0;text-align:center;">Выберите фильтр или введите запрос</div>';
      return;
    }
    if (!products || products.length === 0) {
      list.innerHTML = '<div style="color:#888;padding:30px 0;text-align:center;">Нет товаров по выбранным фильтрам</div>';
      return;
    }
    products.forEach(product => {
      const div = document.createElement('div');
      div.className = 'product';
      const imageUrl = product.image && product.image !== '' ? getBackendFileUrl('images', product.image) : 'images/placeholder.png';
      div.innerHTML = `
        <img src="${imageUrl}" alt="${product.name}" class="product-img" />
        <h2>${product.name}</h2>
        <p class="description">${product.description || ''}</p>
        <p class="price">${product.price === 0 ? 'Бесплатно' : product.price.toLocaleString() + ' ₽'}</p>
        <button class="buy-btn">Купить</button>
      `;
      // Кнопка "Купить" теперь ведёт на страницу товара
      div.querySelector('.buy-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        window.location.href = `product.html?id=${product.id}`;
      });
      // Переход на карточку товара по клику (кроме кнопки)
      div.addEventListener('click', function(e) {
        if (e.target.classList.contains('buy-btn')) return;
        window.location.href = `product.html?id=${product.id}`;
      });
      // Визуальный эффект наведения
      div.style.transition = 'background 0.15s';
      div.addEventListener('mouseover', () => div.style.background = '#e0f7fa');
      div.addEventListener('mouseout', () => div.style.background = '');
      list.appendChild(div);
    });
  }

  async function init() {
    await loadCategories();
    await loadProducts();
    filterAndRender();
    // Удаляем обработчики событий для min/max price
    document.getElementById('search-input').addEventListener('input', filterAndRender);
    document.getElementById('category-filter').addEventListener('change', filterAndRender);
    document.getElementById('sort-select').addEventListener('change', filterAndRender);
    document.getElementById('free-filter').addEventListener('change', filterAndRender);
  }
  init();
  // Стилизация ползунка "Бесплатные"
  const freeFilter = document.getElementById('free-filter');
  const switchBg = freeFilter.nextElementSibling;
  const switchCircle = switchBg.nextElementSibling;
  freeFilter.addEventListener('input', function() {
    if (this.checked) {
      switchBg.style.background = '#43e97b';
      switchCircle.style.left = '17px';
      switchCircle.style.background = '#fff';
    } else {
      switchBg.style.background = '#e0f7fa';
      switchCircle.style.left = '3px';
      switchCircle.style.background = '#43e97b';
    }
  });
  // Инициализация состояния
  freeFilter.dispatchEvent(new Event('input'));

  // Универсальная функция для формирования абсолютного URL к файлу/картинке
  function getBackendFileUrl(type, filename) {
    if (!filename) return '';
    return `https://store-backend-zpkh.onrender.com/${type}/${encodeURIComponent(filename.replace(/^.*[\\/]/, ''))}`;
  }

  function goToPage(url) {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openTelegramLink) {
      window.Telegram.WebApp.openTelegramLink(url);
    } else {
      window.location.href = url;
    }
  }
</script>
<a href="#" class="admin-link" onclick="goToPage('admin.html'); return false;">Админка</a>
  <footer>
    <p>&copy; 2025 Мой Интернет-Магазин</p>
  </footer>
</body>
</html>