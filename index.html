<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Интернет-магазин</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body>
  <header>
    <h1>Мой Интернет-Магазин</h1>
    <div id="welcome">Здравствуйте, гость!</div>
  </header>

  <main>
    <section class="intro">
      <h2>Добро пожаловать!</h2>
      <p>Выберите категорию товаров выше, чтобы начать покупки.</p>
    </section>
    <div class="filters" style="margin:18px 0 18px 0;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;">
      <input type="text" id="search-input" placeholder="Поиск по названию..." style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-size:15px;min-width:160px;">
      <select id="category-filter" style="padding:8px 8px;border-radius:8px;border:1px solid #ccc;">
        <option value="">Все категории</option>
      </select>
      <input type="number" id="min-price" placeholder="Мин. цена" style="padding:8px 8px;border-radius:8px;border:1px solid #ccc;width:90px;">
      <input type="number" id="max-price" placeholder="Макс. цена" style="padding:8px 8px;border-radius:8px;border:1px solid #ccc;width:90px;">
      <select id="sort-select" style="padding:8px 8px;border-radius:8px;border:1px solid #ccc;">
        <option value="">Сортировка</option>
        <option value="price-asc">Цена ↑</option>
        <option value="price-desc">Цена ↓</option>
        <option value="name-asc">Название A-Я</option>
        <option value="name-desc">Название Я-А</option>
      </select>
    </div>
    <div class="products" id="product-list"></div>
    <nav>
      <ul id="category-list">
        <li>Загрузка категорий...</li>
      </ul>
    </nav>
  </main>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user;
    if (user) {
      document.getElementById("welcome").textContent = `Здравствуйте, ${user.first_name}!`;
    }
  </script>
  <script>
  const API_CATEGORIES = "https://store-backend-zpkh.onrender.com/categories";
  const API_PRODUCTS = "https://store-backend-zpkh.onrender.com/products";

  let allCategories = [];
  let allProducts = [];

  async function loadCategories() {
    try {
      const res = await fetch(API_CATEGORIES);
      if (!res.ok) throw new Error("Ошибка загрузки категорий");
      allCategories = await res.json();
      // Для фильтра
      const select = document.getElementById('category-filter');
      select.innerHTML = '<option value="">Все категории</option>';
      allCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
      });
      // Для перехода по категориям
      const ul = document.getElementById("category-list");
      ul.innerHTML = "";
      allCategories.forEach(cat => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="category.html?id=${cat.id}">${cat.name}</a>`;
        ul.appendChild(li);
      });
    } catch (err) {
      document.getElementById("category-list").innerHTML = "<li>Ошибка загрузки категорий</li>";
    }
  }

  async function loadProducts() {
    const res = await fetch(API_PRODUCTS);
    allProducts = await res.json();
  }

  function filterAndRender() {
    const search = document.getElementById('search-input').value.trim().toLowerCase();
    const catId = document.getElementById('category-filter').value;
    const minPrice = parseFloat(document.getElementById('min-price').value);
    const maxPrice = parseFloat(document.getElementById('max-price').value);
    const sort = document.getElementById('sort-select').value;
    // Если не выбран фильтр категории и не введён поисковый запрос — не показываем товары
    if (!catId && !search) {
      renderProducts([]);
      const list = document.getElementById('product-list');
      list.innerHTML = '<div style="color:#888;padding:30px 0;">Выберите категорию или введите запрос для поиска товаров.</div>';
      return;
    }
    let filtered = allProducts.slice();
    if (catId) filtered = filtered.filter(p => p.category === catId);
    if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
    if (!isNaN(minPrice)) filtered = filtered.filter(p => p.price >= minPrice);
    if (!isNaN(maxPrice)) filtered = filtered.filter(p => p.price <= maxPrice);
    if (sort === 'price-asc') filtered.sort((a,b)=>a.price-b.price);
    if (sort === 'price-desc') filtered.sort((a,b)=>b.price-a.price);
    if (sort === 'name-asc') filtered.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
    if (sort === 'name-desc') filtered.sort((a,b)=>b.name.localeCompare(a.name,'ru'));
    renderProducts(filtered);
  }

  function renderProducts(products, showPlaceholder) {
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    if (showPlaceholder) {
      list.innerHTML = '<div style="color:#888;padding:30px 0;text-align:center;">Выберите фильтр или введите запрос</div>';
      return;
    }
    if (!products || products.length === 0) {
      list.innerHTML = '<div style="color:#888;padding:30px 0;">Товары не найдены.</div>';
      return;
    }
    products.forEach(product => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <img src="${product.image}" alt="${product.name}" class="product-img" />
        <h2>${product.name}</h2>
        <p class="description">${product.description || ''}</p>
        <p class="price">${product.price.toLocaleString()} ₽</p>
        <button class="buy-btn">Купить</button>
      `;
      list.appendChild(div);
    });
  }

  async function init() {
    await loadCategories();
    await loadProducts();
    filterAndRender();
    document.getElementById('search-input').addEventListener('input', filterAndRender);
    document.getElementById('category-filter').addEventListener('change', filterAndRender);
    document.getElementById('min-price').addEventListener('input', filterAndRender);
    document.getElementById('max-price').addEventListener('input', filterAndRender);
    document.getElementById('sort-select').addEventListener('change', filterAndRender);
  }
  init();
</script>
<a href="admin.html" class="admin-link">Админка</a>
  <footer>
    <p>&copy; 2025 Мой Интернет-Магазин</p>
  </footer>
</body>
</html>