<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body>
  <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–∫–∞—Ç–∞–ª–æ–≥, —Ñ–∏–ª—å—Ç—Ä—ã, —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤) -->
  <div id="home-page" class="spa-page">
    <header style="position:relative;">
      <h1>–ú–æ–π –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ú–∞–≥–∞–∑–∏–Ω</h1>
      <div id="welcome">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –≥–æ—Å—Ç—å!</div>
      <div id="balance-block" style="float:right;margin-top:8px;margin-right:8px;display:none;"></div>
    </header>
    <main>
      <section class="intro">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏.</p>
      </section>
      <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
      <div class="filters" style="margin:18px 0 10px 0;display:flex;flex-direction:column;gap:8px;align-items:center;max-width:440px;width:100%;margin-left:auto;margin-right:auto;">
        <div style="width:100%;display:flex;justify-content:center;align-items:center;">
          <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." style="padding:10px 16px;border-radius:10px;border:1.5px solid #e0f7fa;font-size:15px;min-width:160px;width:100%;max-width:440px;box-sizing:border-box;background:#f8fdfd;outline:none;height:48px;">
        </div>
        <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;width:100%;max-width:440px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span title="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" style="display:inline-flex;align-items:center;">
              <svg width="18" height="18" style="margin-right:3px;vertical-align:middle;" viewBox="0 0 24 24">
                <path fill="#00916e" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
              </svg>
            </span>
            <select id="category-filter" style="padding:9px 14px;border-radius:9px;border:1.5px solid #e0f7fa;min-width:110px;font-size:14px;background:#f8fdfd;outline:none;height:48px;">
              <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" style="display:inline-flex;align-items:center;">
              <svg width="18" height="18" style="margin-right:3px;vertical-align:middle;" viewBox="0 0 24 24">
                <path fill="#00916e" d="M3 18h6v-2H3v2zm0-5h12v-2H3v2zm0-7v2h18V6H3z"/>
              </svg>
            </span>
            <select id="sort-select" style="padding:9px 14px;border-radius:9px;border:1.5px solid #e0f7fa;min-width:110px;font-size:14px;background:#f8fdfd;outline:none;height:48px;">
              <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
              <option value="price-asc">–¶–µ–Ω–∞ ‚Üë</option>
              <option value="price-desc">–¶–µ–Ω–∞ ‚Üì</option>
              <option value="name-asc">–ù–∞–∑–≤–∞–Ω–∏–µ A-–Ø</option>
              <option value="name-desc">–ù–∞–∑–≤–∞–Ω–∏–µ –Ø-–ê</option>
            </select>
          </div>
          <div style="margin-left:auto;display:flex;align-items:center;">
            <label style="display:flex;align-items:center;gap:8px;border:2px solid #43e97b;border-radius:12px;padding:4px 14px 4px 10px;cursor:pointer;background:#f8fdfd;user-select:none;">
              <span style="font-size:13px;color:#00916e;font-weight:600;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
              <span style="position:relative;display:inline-block;width:38px;height:24px;">
                <input type="checkbox" id="free-filter" style="opacity:0;width:38px;height:24px;margin:0;position:absolute;left:0;top:0;z-index:2;cursor:pointer;">
                <span style="position:absolute;left:0;top:0;width:38px;height:24px;background:#e0f7fa;border-radius:12px;transition:.2s;"></span>
                <span style="position:absolute;top:3px;left:3px;width:18px;height:18px;background:#43e97b;border-radius:50%;transition:.2s;"></span>
              </span>
            </label>
          </div>
        </div>
      </div>
      <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div class="products" id="product-list"><!-- JS: renderProducts() --></div>
      <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <nav>
        <ul id="category-list"><li>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</li></ul>
      </nav>
    </main>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div id="account-page" class="spa-page" style="display:none;">
    <h2>–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</h2>
    <div id="account-info" style="margin:18px 0 24px 0;padding:18px 22px;border-radius:12px;background:#f8fdfd;max-width:420px;box-shadow:0 2px 12px #0001;">
      <div id="tg-user-block">
        <b>Telegram ID:</b> <span id="tg-id">‚Äî</span><br>
        <b>–ò–º—è:</b> <span id="tg-name">‚Äî</span>
      </div>
      <div id="account-status" style="margin-top:10px;color:#00916e;font-weight:600;"></div>
      <div id="balance-block" style="margin-top:18px;text-align:right;display:none;"></div>
    </div>
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π</h2>
    <div id="history-list" style="margin-bottom:24px;">‚Äî</div>
    <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
    <div id="favorites-list">‚Äî</div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–¥–º–∏–Ω–∫–∏ -->
  <div id="admin-page" class="spa-page" style="display:none;">
    <h2>–ê–¥–º–∏–Ω–∫–∞</h2>
    <div id="admin-content">
      <button type="button" class="section-btn" style="margin:10px 0 16px 0;padding:10px 22px;border-radius:10px;background:#00916e;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.1em;">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</button>
      <form id="add-product-form">
        <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
        <input type="text" id="name" required />
        <label for="price">–¶–µ–Ω–∞ (–≤ —Ä—É–±–ª—è—Ö)</label>
        <div style="display:flex;align-items:center;gap:12px;">
          <input type="number" id="price" min="0" required style="flex:1;" />
          <label style="display:flex;align-items:center;gap:4px;font-size:1em;">
            <input type="checkbox" id="is-free" style="accent-color:#43e97b;" /> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </label>
        </div>
        <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="description"></textarea>
        <label for="image" style="font-weight:700;color:#00916e;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
        <div id="drop-area" style="flex:1;max-width:220px;padding:12px 8px;border:2px dashed #43e97b;border-radius:10px;text-align:center;cursor:pointer;background:#f8fdfd;transition:background 0.2s;">
          <input type="file" id="image-file" accept="image/*" style="display:none;" />
          <span id="drop-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
          <div id="image-preview" style="margin-top:8px;display:none;"></div>
        </div>
        <input type="hidden" id="image" name="image" />
        <label for="file" style="font-weight:700;color:#00916e;">–§–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è/–ø–æ–∫—É–ø–∫–∏</label>
        <div id="file-drop-area" style="flex:1;max-width:320px;padding:12px 8px;border:2px dashed #43e97b;border-radius:10px;text-align:center;cursor:pointer;background:#f8fdfd;transition:background 0.2s;margin-bottom:8px;">
          <input type="file" id="file-input" style="display:none;" />
          <span id="file-drop-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
          <div id="file-preview" style="margin-top:8px;display:none;font-size:0.98em;color:#00916e;"></div>
        </div>
        <input type="hidden" id="file" name="file" />
        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="category" required>
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
        </select>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </form>
      <hr>
      <button type="button" class="section-btn" style="margin:18px 0 10px 0;padding:10px 22px;border-radius:10px;background:#00916e;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.1em;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</button>
      <form id="add-category-form">
        <input type="text" id="category-name" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" required style="padding:7px 12px;border-radius:7px;border:1.5px solid #e0f7fa;">
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
      </form>
    </div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <div id="category-page" class="spa-page" style="display:none;">
    <h2 id="category-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h2>
    <div id="category-products">‚Äî</div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="product-page" class="spa-page" style="display:none;">
    <h2>–¢–æ–≤–∞—Ä</h2>
    <div id="product-card">‚Äî</div>
  </div>

  <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ SPA -->
  <nav id="bottom-tabs" style="position:fixed;left:0;right:0;bottom:0;height:62px;background:#fff;border-top:1.5px solid #e0f7fa;display:flex;justify-content:space-around;align-items:center;z-index:1000;box-shadow:0 -2px 16px #0001;">
    <button class="tab-btn" onclick="showPage('home-page')" style="background:none;border:none;outline:none;display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;cursor:pointer;font-size:1.2em;color:#00916e;">
      <span style="font-size:1.6em;">üè†</span>
      <span style="font-size:0.85em;">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="tab-btn" onclick="showPage('category-page')" style="background:none;border:none;outline:none;display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;cursor:pointer;font-size:1.2em;color:#00916e;">
      <span style="font-size:1.6em;">üìÇ</span>
      <span style="font-size:0.85em;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
    </button>
    <button class="tab-btn" onclick="showPage('product-page')" style="background:none;border:none;outline:none;display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;cursor:pointer;font-size:1.2em;color:#00916e;">
      <span style="font-size:1.6em;">üõí</span>
      <span style="font-size:0.85em;">–¢–æ–≤–∞—Ä—ã</span>
    </button>
    <button class="tab-btn" onclick="showPage('account-page')" style="background:none;border:none;outline:none;display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;cursor:pointer;font-size:1.2em;color:#00916e;">
      <span style="font-size:1.6em;">üë§</span>
      <span style="font-size:0.85em;">–ê–∫–∫–∞—É–Ω—Ç</span>
    </button>
    <button class="tab-btn" onclick="showPage('admin-page')" style="background:none;border:none;outline:none;display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;cursor:pointer;font-size:1.2em;color:#00916e;">
      <span style="font-size:1.6em;">‚öôÔ∏è</span>
      <span style="font-size:0.85em;">–ê–¥–º–∏–Ω</span>
    </button>
  </nav>

  <style>
    body { padding-bottom: 70px; }
    #bottom-tabs .tab-btn.active span { color: #43e97b; }
    #bottom-tabs .tab-btn span { transition: color 0.2s; }
    @media (max-width: 600px) {
      #bottom-tabs { height: 56px; }
      #bottom-tabs .tab-btn span { font-size: 1.3em; }
    }
  </style>

  <footer>
    <p>&copy; 2025 –ú–æ–π –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ú–∞–≥–∞–∑–∏–Ω</p>
  </footer>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ SPA –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö -->
  <script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Telegram WebApp API
  function getTelegramUser() {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
      return window.Telegram.WebApp.initDataUnsafe.user;
    }
    return null;
  }

  function showAccountInfo(user) {
    document.getElementById('tg-id').textContent = user.id;
    document.getElementById('tg-name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    document.getElementById('account-status').textContent = '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω';
  }

  function createAccountIfNeeded(user) {
    // –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
    fetch('https://store-backend-zpkh.onrender.com/account', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegram_id: user.id,
        name: user.first_name + (user.last_name ? ' ' + user.last_name : '')
      })
    })
    .then(res => res.json())
    .then(data => {
      // –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
      loadHistory(user.id);
      loadFavorites(user.id);
    })
    .catch(() => {
      document.getElementById('account-status').textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞';
    });
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString().slice(0,5);
  }
  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ URL –∫ —Ñ–∞–π–ª—É/–∫–∞—Ä—Ç–∏–Ω–∫–µ
  function getBackendFileUrl(type, filename) {
    if (!filename) return '';
    return `https://store-backend-zpkh.onrender.com/${type}/${encodeURIComponent(filename.replace(/^.*[\\/]/, ''))}`;
  }
  async function loadHistory(telegramId) {
    const list = document.getElementById('history-list');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/account/' + telegramId + '/history');
      const data = await res.json();
      if (data && data.length) {
        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
        const productsRes = await fetch('https://store-backend-zpkh.onrender.com/products');
        const products = await productsRes.json();
        list.innerHTML = data.reverse().map(item => {
          const prod = products.find(p=>p.id===item.productId);
          if (!prod) return '';
          const imageUrl = prod.image ? getBackendFileUrl('images', prod.image) : 'images/placeholder.png';
          const ext = prod.file ? prod.file.split('.').pop().toLowerCase() : '';
          let icon = '';
          if (["pdf"].includes(ext)) icon = 'üìÑ';
          else if (["zip","rar","7z"].includes(ext)) icon = 'üóúÔ∏è';
          else if (["doc","docx","txt","rtf"].includes(ext)) icon = 'üìù';
          else if (["xls","xlsx","csv"].includes(ext)) icon = 'üìä';
          else if (["png","jpg","jpeg","gif","bmp","webp"].includes(ext)) icon = 'üñºÔ∏è';
          else if (["blend","obj","fbx","stl"].includes(ext)) icon = 'üß©';
          else icon = 'üì¶';
          let extra = '';
          if (!item.expired && item.daysLeft <= 2) extra = `<div style=\"color:#e67e22;font-size:0.97em;\">–í–Ω–∏–º–∞–Ω–∏–µ: –¥–æ—Å—Ç—É–ø –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${item.daysLeft} ${item.daysLeft===1?'–¥–µ–Ω—å':'–¥–Ω—è'}!</div>`;
          if (item.expired) extra = '<div style="color:#aaa;font-size:0.97em;">–î–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫. <a href="#" onclick="showProduct(\''+prod.id+'\');return false;" style="color:#00916e;text-decoration:underline;">–ö—É–ø–∏—Ç—å —Å–Ω–æ–≤–∞</a></div>';
          return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:${item.expired?'#f4f4f4':'#fff'};padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;opacity:${item.expired?'0.6':'1'};">
            <img src="${imageUrl}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;filter:${item.expired?'grayscale(1)':''};">
            <div style="flex:1;">
              <b>${prod.name}</b><br>
              <span style="color:#888;font-size:0.98em;">${icon} ${prod.file ? prod.file.split('/').pop() : ''}</span><br>
              <span style="color:#43e97b;font-size:0.97em;">${formatDate(item.date)}</span>
              ${extra}
            </div>
            <a href="#" onclick="showProduct('${prod.id}');return false;" style="color:#00916e;font-size:1.3em;margin-right:8px;" title="–ö —Ç–æ–≤–∞—Ä—É">üîé</a>
            ${prod.file && !item.expired ? `<button onclick="downloadFile('${prod.id}')" style="background:#00916e;color:#fff;border:none;border-radius:8px;padding:7px 13px;cursor:pointer;font-size:1em;">‚¨áÔ∏è</button>` : ''}
          </div>`;
        }).join('') + '<div style="color:#888;font-size:0.98em;margin-top:8px;">* –î–æ—Å—Ç—É–ø –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –æ—Ç–∫—Ä—ã—Ç 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏</div>';
      } else {
        list.innerHTML = '<div style="color:#888;text-align:center;">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –∏–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π.</div>';
      }
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.';
    }
  }
  async function downloadFile(productId) {
    if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram'); return;
    }
    const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
    const resp = await fetch('https://store-backend-zpkh.onrender.com/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: telegramId, productId })
    });
    const data = await resp.json();
    if (resp.ok && data.url) {
      const link = document.createElement('a');
      link.href = data.url;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
    }
  }
  async function loadFavorites(telegramId) {
    const list = document.getElementById('favorites-list');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/account/' + telegramId + '/favorites');
      const data = await res.json();
      if (data && data.length) {
        list.innerHTML = data.map(prod => {
          const imageUrl = prod.image ? getBackendFileUrl('images', prod.image) : 'images/placeholder.png';
          const ext = prod.file ? prod.file.split('.').pop().toLowerCase() : '';
          let icon = '';
          if (["pdf"].includes(ext)) icon = 'üìÑ';
          else if (["zip","rar","7z"].includes(ext)) icon = 'üóúÔ∏è';
          else if (["doc","docx","txt","rtf"].includes(ext)) icon = 'üìù';
          else if (["xls","xlsx","csv"].includes(ext)) icon = 'üìä';
          else if (["png","jpg","jpeg","gif","bmp","webp"].includes(ext)) icon = 'üñºÔ∏è';
          else if (["blend","obj","fbx","stl"].includes(ext)) icon = 'üß©';
          else icon = 'üì¶';
          return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:#fff;padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;">
            <img src="${imageUrl}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;">
            <div style="flex:1;">
              <b>${prod.name}</b><br>
              <span style="color:#888;font-size:0.98em;">${icon} ${prod.file ? prod.file.split('/').pop() : ''}</span>
            </div>
            <a href="#" onclick="showProduct('${prod.id}');return false;" style="color:#00916e;font-size:1.3em;margin-right:8px;" title="–ö —Ç–æ–≤–∞—Ä—É">üîé</a>
            ${prod.file ? `<button onclick="downloadFile('${prod.id}')" style="background:#00916e;color:#fff;border:none;border-radius:8px;padding:7px 13px;cursor:pointer;font-size:1em;">‚¨áÔ∏è</button>` : ''}
          </div>`;
        }).join('');
      } else {
        list.textContent = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.';
      }
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.';
    }
  }
  function showToast(msg, color) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.background = color || '#222';
    toast.style.display = 'block';
    toast.style.opacity = '0.97';
    setTimeout(()=>{ toast.style.opacity = '0'; }, 2200);
    setTimeout(()=>{ toast.style.display = 'none'; }, 2600);
  }
  // --- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ ---
  let lastBalance = null;
  async function updateBalance(telegramId, showToastOnChange) {
    const balanceBlock = document.getElementById('balance-block');
    if (!telegramId) return;
    try {
      const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/balance`);
      const data = await resp.json();
      if (resp.ok) {
        balanceBlock.style.display = '';
        balanceBlock.innerHTML = `<span style='color:#f9b32b;font-weight:600;'>–ë–∞–ª–∞–Ω—Å: </span><span id='balance-value' style='color:#222;font-weight:700;'>${data.balance.toLocaleString()} ‚ÇΩ</span> <button id='topup-btn' style='margin-left:8px;padding:4px 12px;border-radius:8px;background:#fff;color:#f9b32b;border:1px solid #f9b32b;cursor:pointer;font-size:0.98em;'>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>`;
        if (lastBalance !== null && data.balance !== lastBalance && showToastOnChange) {
          showToast('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω!', '#43e97b');
        }
        lastBalance = data.balance;
        document.getElementById('topup-btn').onclick = function() {
          document.getElementById('topup-modal').style.display = 'flex';
          document.getElementById('topup-amount').value = '';
          document.getElementById('topup-error').textContent = '';
          document.getElementById('topup-check').style.display = 'none';
        };
        document.getElementById('topup-close').onclick = function() {
          document.getElementById('topup-modal').style.display = 'none';
        };
        document.getElementById('topup-check').onclick = function() {
          updateBalance(telegramId, true);
        };
        document.getElementById('topup-confirm').onclick = async function() {
          const sum = document.getElementById('topup-amount').value.trim();
          const amount = Number(sum);
          const system = document.getElementById('topup-system').value;
          const errorDiv = document.getElementById('topup-error');
          if (!amount || isNaN(amount) || amount <= 0) {
            errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É';
            return;
          }
          errorDiv.textContent = '';
          document.getElementById('topup-confirm').disabled = true;
          document.getElementById('topup-confirm').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';
          try {
            const resp = await fetch(`https://store-backend-zpkh.onrender.com/create_payment_link`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount, telegramId, system })
            });
            const data = await resp.json();
            if (resp.ok && data.url) {
              window.open(data.url, '_blank');
              document.getElementById('topup-modal').style.display = 'flex';
              document.getElementById('topup-check').style.display = '';
              showToast('–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å"', '#f9b32b');
            } else {
              errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞';
            }
          } catch {
            errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
          }
          document.getElementById('topup-confirm').disabled = false;
          document.getElementById('topup-confirm').textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å';
        };
      }
    } catch {}
  }

  // --- SPA: –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ ---
  function showPage(pageId) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.querySelectorAll('.spa-page').forEach(p => p.style.display = 'none');
    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é
    document.getElementById(pageId).style.display = '';
    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.querySelectorAll('#bottom-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
    let idx = ['home-page','category-page','product-page','account-page','admin-page'].indexOf(pageId);
    if (idx >= 0) document.querySelectorAll('#bottom-tabs .tab-btn')[idx].classList.add('active');
    // SPA: –ø–æ–¥–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü
    if (pageId === 'home-page') {
      renderProducts();
      renderCategories();
      updateBalance(getTelegramUser()?.id);
    }
    if (pageId === 'category-page') {
      renderCategories(true);
      // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
      if(window._currentCategoryId) {
        updateCategoryTitle(window._currentCategoryId);
        loadCategory(window._currentCategoryId);
      }
    }
    if (pageId === 'account-page') {
      const user = getTelegramUser();
      if (user) {
        showAccountInfo(user);
        loadHistory(user.id);
        loadFavorites(user.id);
        updateBalance(user.id);
      }
    }
    if (pageId === 'admin-page') {
      renderAdmin();
      // TODO: –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    }
    if (pageId === 'product-page') {
      if(window._currentProductId) {
        loadProduct(window._currentProductId);
      }
    }
    // –ë–∞–ª–∞–Ω—Å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∏ –∞–∫–∫–∞—É–Ω—Ç–µ
    document.getElementById('balance-block').style.display = (pageId === 'home-page' || pageId === 'account-page') ? '' : 'none';
    // –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    if (!window._spaNavSilent) {
      history.pushState({pageId}, '', '#' + pageId);
    }
  }

  // SPA: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
  window.onpopstate = function(e) {
    if (e.state && e.state.pageId) {
      window._spaNavSilent = true;
      showPage(e.state.pageId);
      window._spaNavSilent = false;
    }
  };

  // --- SPA: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
  async function renderProducts() {
    const list = document.getElementById('product-list');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/products');
      let products = await res.json();
      // –ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
      products = products.sort(() => Math.random() - 0.5);
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
      const search = document.getElementById('search-input').value.trim().toLowerCase();
      const cat = document.getElementById('category-filter').value;
      const free = document.getElementById('free-filter').checked;
      if (search) products = products.filter(p => p.name.toLowerCase().includes(search));
      if (cat) products = products.filter(p => p.categoryId === cat);
      if (free) products = products.filter(p => p.price === 0);
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      const sort = document.getElementById('sort-select').value;
      if (sort === 'price-asc') products.sort((a,b)=>a.price-b.price);
      if (sort === 'price-desc') products.sort((a,b)=>b.price-a.price);
      if (sort === 'name-asc') products.sort((a,b)=>a.name.localeCompare(b.name));
      if (sort === 'name-desc') products.sort((a,b)=>b.name.localeCompare(a.name));
      // –†–µ–Ω–¥–µ—Ä
      if (!products.length) {
        list.innerHTML = '<div style="color:#888;text-align:center;">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</div>';
        return;
      }
      list.innerHTML = products.map(prod => {
        const imageUrl = prod.image ? getBackendFileUrl('images', prod.image) : 'images/placeholder.png';
        return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:#fff;padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;" onclick="showProduct('${prod.id}')">
          <img src="${imageUrl}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;">
          <div style="flex:1;">
            <b>${prod.name}</b><br>
            <span style="color:#888;font-size:0.98em;">${prod.price ? prod.price + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
          </div>
          <span style="color:#00916e;font-size:1.3em;margin-right:8px;">üîé</span>
        </div>`;
      }).join('');
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.';
    }
  }

  async function renderCategories(forPage = false) {
    const list = forPage ? document.getElementById('category-products') : document.getElementById('category-list');
    list.innerHTML = '<li style="color:#888;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/categories');
      const cats = await res.json();
      if (!cats.length) {
        list.innerHTML = '<li style="color:#888;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π.</li>';
        return;
      }
      if (forPage) {
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∫ –ø–ª–∏—Ç–∫–∏
        list.innerHTML = cats.map(cat =>
          `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;cursor:pointer;background:#f8fdfd;padding:10px 12px;border-radius:10px;box-shadow:0 2px 8px #0001;" onclick="showCategory('${cat.id}')">
            <span style="font-size:1.5em;">üìÇ</span>
            <span style="font-weight:600;">${cat.name}</span>
          </div>`
        ).join('');
      } else {
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∫ —Å–ø–∏—Å–æ–∫
        list.innerHTML = cats.map(cat =>
          `<li style="margin-bottom:7px;cursor:pointer;" onclick="showCategory('${cat.id}')">${cat.name}</li>`
        ).join('');
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const sel = document.getElementById('category-filter');
        sel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + cats.map(cat =>
          `<option value="${cat.id}">${cat.name}</option>`
        ).join('');
      }
    } catch {
      list.innerHTML = '<li style="color:#888;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.</li>';
    }
  }

  // SPA: –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  async function loadCategory(categoryId) {
    const list = document.getElementById('category-products');
    list.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/products');
      let products = await res.json();
      products = products.filter(p => p.categoryId === categoryId);
      if (!products.length) {
        list.innerHTML = '<div style="color:#888;text-align:center;">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>';
        return;
      }
      list.innerHTML = products.map(prod => {
        const imageUrl = prod.image ? getBackendFileUrl('images', prod.image) : 'images/placeholder.png';
        return `<div class="product" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;background:#fff;padding:10px 8px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;" onclick="showProduct('${prod.id}')">
          <img src="${imageUrl}" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:8px;">
          <div style="flex:1;">
            <b>${prod.name}</b><br>
            <span style="color:#888;font-size:0.98em;">${prod.price ? prod.price + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
          </div>
          <span style="color:#00916e;font-size:1.3em;margin-right:8px;">üîé</span>
        </div>`;
      }).join('');
    } catch {
      list.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.';
    }
  }

  // SPA: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
  async function loadProduct(productId) {
    const card = document.getElementById('product-card');
    card.innerHTML = '<div style="color:#888;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/products');
      const products = await res.json();
      const prod = products.find(p => p.id === productId);
      if (!prod) {
        card.innerHTML = '<div style="color:#888;text-align:center;">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
        return;
      }
      const imageUrl = prod.image ? getBackendFileUrl('images', prod.image) : 'images/placeholder.png';
      card.innerHTML = `
        <div style="display:flex;gap:18px;align-items:flex-start;">
          <img src="${imageUrl}" alt="img" style="width:90px;height:90px;object-fit:cover;border-radius:12px;">
          <div style="flex:1;">
            <h3 style="margin:0 0 8px 0;">${prod.name}</h3>
            <div style="color:#888;font-size:1em;margin-bottom:8px;">${prod.price ? prod.price + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</div>
            <div style="font-size:0.98em;margin-bottom:10px;">${prod.description || ''}</div>
            <button onclick="buyProduct('${prod.id}')" style="background:#43e97b;color:#fff;border:none;border-radius:8px;padding:10px 18px;cursor:pointer;font-size:1.08em;">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      `;
    } catch {
      card.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞.';
    }
  }

  // SPA: –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞ (–∑–∞–≥–ª—É—à–∫–∞)
  function buyProduct(productId) {
    showToast('–ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', '#43e97b');
  }

  // SPA: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–¥–º–∏–Ω–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)
  function renderAdmin() {
    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    fetch('https://store-backend-zpkh.onrender.com/categories')
      .then(res => res.json())
      .then(cats => {
        const sel = document.getElementById('category');
        sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>' + cats.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
      });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    document.getElementById('add-product-form').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const price = document.getElementById('is-free').checked ? 0 : Number(document.getElementById('price').value);
      const description = document.getElementById('description').value.trim();
      const image = document.getElementById('image').value;
      const file = document.getElementById('file').value;
      const categoryId = document.getElementById('category').value;
      if (!name || !categoryId) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', '#e74c3c');
        return;
      }
      const body = { name, price, description, image, file, categoryId };
      try {
        const resp = await fetch('https://store-backend-zpkh.onrender.com/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (resp.ok) {
          showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', '#43e97b');
          document.getElementById('add-product-form').reset();
          renderProducts();
        } else {
          showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', '#e74c3c');
        }
      } catch {
        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', '#e74c3c');
      }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('add-category-form').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('category-name').value.trim();
      if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', '#e74c3c');
        return;
      }
      try {
        const resp = await fetch('https://store-backend-zpkh.onrender.com/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (resp.ok) {
          showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!', '#43e97b');
          document.getElementById('add-category-form').reset();
          renderCategories();
        } else {
          showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', '#e74c3c');
        }
      } catch {
        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', '#e74c3c');
      }
    };
  }

  // --- SPA: –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ ---
  document.addEventListener('DOMContentLoaded', function() {
    // SPA: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    showPage('home-page');
    renderProducts();
    renderCategories();
    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('search-input').addEventListener('input', renderProducts);
    document.getElementById('category-filter').addEventListener('change', renderProducts);
    document.getElementById('sort-select').addEventListener('change', renderProducts);
    document.getElementById('free-filter').addEventListener('change', renderProducts);
    // SPA: –µ—Å–ª–∏ –µ—Å—Ç—å hash –≤ url, –æ—Ç–∫—Ä—ã—Ç—å –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    if (location.hash && document.getElementById(location.hash.slice(1))) {
      showPage(location.hash.slice(1));
    }
  });

  // === DEBUG: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Telegram WebApp API ===
  function showDebugInfo() {
    const debugDiv = document.createElement('div');
    debugDiv.style = 'background:#fffbe6;color:#b36b00;padding:10px 14px;border-radius:8px;margin:18px 0;font-size:0.98em;word-break:break-all;';
    debugDiv.innerHTML = '<b>DEBUG Telegram WebApp:</b><br>' +
      '<pre style="white-space:pre-wrap;">' +
      JSON.stringify({
        Telegram: window.Telegram,
        WebApp: window.Telegram && window.Telegram.WebApp,
        initDataUnsafe: window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe
      }, null, 2) + '</pre>';
    document.body.insertBefore(debugDiv, document.getElementById('account-info').nextSibling);
  }

  // === –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ ===
  function tryInitAccount(attempt = 1) {
    const user = getTelegramUser();
    if (user) {
      showAccountInfo(user);
      createAccountIfNeeded(user);
      updateBalance(user.id);
    } else if (attempt < 5) {
      setTimeout(() => tryInitAccount(attempt + 1), 600);
    } else {
      document.getElementById('account-status').textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.';
      showDebugInfo();
    }
  }

  function goToPage(url) {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openTelegramLink) {
      window.Telegram.WebApp.openTelegramLink(url);
    } else {
      window.location.href = url;
    }
  }

  // SPA: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –ø–æ id
  function showProduct(productId) {
    window._currentProductId = productId;
    showPage('product-page');
    loadProduct(productId);
  }
  // SPA: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ id
  function showCategory(categoryId) {
    window._currentCategoryId = categoryId;
    showPage('category-page');
    updateCategoryTitle(categoryId);
    loadCategory(categoryId);
  }
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  async function updateCategoryTitle(categoryId) {
    try {
      const res = await fetch('https://store-backend-zpkh.onrender.com/categories');
      const cats = await res.json();
      const cat = cats.find(c => c.id === categoryId);
      document.getElementById('category-title').textContent = cat ? cat.name : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
    } catch {
      document.getElementById('category-title').textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
    }
  }

  window.addEventListener('DOMContentLoaded', function() {
    tryInitAccount();
    // Polling –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
    let pollInterval = null;
    document.getElementById('topup-modal').addEventListener('transitionstart', function() {
      const user = getTelegramUser();
      if (this.style.display === 'flex' && user) {
        pollInterval = setInterval(()=>updateBalance(user.id, true), 7000);
      } else {
        clearInterval(pollInterval);
      }
    });
  });
  </script>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
  <div id="topup-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:18px;box-shadow:0 8px 32px #0003;max-width:340px;width:90vw;position:relative;">
      <button id="topup-close" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.3em;color:#bbb;cursor:pointer;">√ó</button>
      <h2 style="margin:0 0 18px 0;font-size:1.2em;color:#00916e;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
      <label for="topup-amount" style="color:#444;font-size:1em;">–°—É–º–º–∞ (‚ÇΩ):</label>
      <input id="topup-amount" type="number" min="1" step="1" style="width:100%;margin:10px 0 12px 0;padding:10px 12px;border-radius:8px;border:1px solid #eee;font-size:1.1em;" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />
      <label for="topup-system" style="color:#444;font-size:1em;">–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</label>
      <select id="topup-system" style="width:100%;margin:10px 0 12px 0;padding:8px 10px;border-radius:8px;border:1px solid #eee;font-size:1.05em;">
        <option value="yookassa">–ÆKassa</option>
        <option value="cloudpayments">CloudPayments</option>
      </select>
      <div id="topup-error" style="color:#e74c3c;font-size:0.98em;min-height:20px;margin-bottom:8px;"></div>
      <button id="topup-confirm" style="width:100%;padding:12px 0;border-radius:10px;background:#f9b32b;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.08em;">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button id="topup-check" style="width:100%;padding:10px 0;border-radius:10px;background:#00916e;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.02em;margin-top:10px;display:none;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    </div>
  </div>

  <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="toast" style="display:none;position:fixed;left:50%;bottom:32px;transform:translateX(-50%);background:#222;color:#fff;padding:14px 28px;border-radius:12px;font-size:1.08em;z-index:2000;box-shadow:0 4px 24px #0005;opacity:0.97;transition:opacity 0.3s;"></div>

</body>
</html>
