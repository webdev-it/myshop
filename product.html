<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢–æ–≤–∞—Ä</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body>
  <header style="position:relative;">
    <a href="#" class="back" onclick="goToPage('index.html'); return false;">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <a id="profile-link" href="#" style="display:none;position:absolute;top:16px;right:16px;text-decoration:none;" onclick="goToPage('account.html'); return false;">
      <div id="profile-avatar" style="width:44px;height:44px;border-radius:50%;overflow:hidden;box-shadow:0 2px 8px #0002;background:#e0f7fa;display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:700;color:#00916e;"></div>
    </a>
  </header>
  <main>
    <div id="product-card" style="max-width:420px;margin:40px auto;padding:24px 18px;background:#fff;border-radius:18px;box-shadow:0 4px 24px #0001;min-height:320px;">
      <div id="loading-indicator" style="color:#00916e;text-align:center;padding:40px 0;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–∞...</div>
      <div id="product-image" style="text-align:center;margin-bottom:18px;display:none;"></div>
      <h1 id="product-name" style="margin-bottom:10px;display:none;"></h1>
      <div id="product-id" style="color:#bbb;font-size:0.95em;margin-bottom:4px;display:none;"></div>
      <div id="product-category" style="color:#00916e;font-weight:600;margin-bottom:8px;display:none;"></div>
      <div id="product-price" style="font-size:1.2em;font-weight:700;margin-bottom:12px;display:none;"></div>
      <div id="product-description" style="color:#444;margin-bottom:18px;display:none;"></div>
      <div id="product-file" style="margin-bottom:16px;display:none;"></div>
      <div id="balance-block" style="text-align:right;margin-bottom:8px;display:none;"></div>
      <div id="favorite-block" style="text-align:right;margin-bottom:8px;display:none;"></div>
      <button id="buy-btn" style="padding:14px 36px;border-radius:12px;background:#00916e;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.15em;box-shadow:0 2px 8px #00916e22;display:none;transition:background 0.2s;">–ö—É–ø–∏—Ç—å</button>
      <button id="buy-balance-btn" style="padding:14px 36px;border-radius:12px;background:#f9b32b;color:#fff;font-weight:700;border:none;cursor:pointer;font-size:1.15em;box-shadow:0 2px 8px #f9b32b22;display:none;transition:background 0.2s;margin-top:10px;">–ö—É–ø–∏—Ç—å –∑–∞ –±–∞–ª–∞–Ω—Å</button>
    </div>
  </main>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const API_PRODUCTS = 'https://store-backend-zpkh.onrender.com/products';
    const API_CATEGORIES = 'https://store-backend-zpkh.onrender.com/categories';

    function showNotFound() {
      document.getElementById('product-card').innerHTML = '<div style="color:#888;padding:40px 0;text-align:center;">–ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –±—ã–ª —É–¥–∞–ª—ë–Ω.<br><a href="#" onclick="goToPage(\'index.html\'); return false;" style="color:#00916e;text-decoration:underline;display:inline-block;margin-top:18px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a></div>';
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ URL –∫ —Ñ–∞–π–ª—É/–∫–∞—Ä—Ç–∏–Ω–∫–µ
    function getBackendFileUrl(type, filename) {
      if (!filename) return '';
      return `https://store-backend-zpkh.onrender.com/${type}/${encodeURIComponent(filename.replace(/^.*[\\/]/, ''))}`;
    }

    async function loadProductAndCategory() {
      if (!id) return showNotFound();
      try {
        const [productsRes, categoriesRes] = await Promise.all([
          fetch(API_PRODUCTS),
          fetch(API_CATEGORIES)
        ]);
        if (!productsRes.ok || !categoriesRes.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        const products = await productsRes.json();
        const categories = await categoriesRes.json();
        const product = products.find(p => p.id === id);
        if (!product) return showNotFound();
        const category = categories.find(c => c.id === product.category);
        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('product-image').style.display = '';
        document.getElementById('product-name').style.display = '';
        document.getElementById('product-id').style.display = '';
        document.getElementById('product-category').style.display = '';
        document.getElementById('product-price').style.display = '';
        document.getElementById('product-description').style.display = '';
        document.getElementById('buy-btn').style.display = '';
        document.getElementById('product-name').textContent = product.name;
        document.getElementById('product-id').textContent = `ID —Ç–æ–≤–∞—Ä–∞: ${product.id}`;
        document.getElementById('product-id').style.display = '';
        document.getElementById('product-category').innerHTML = category ? `<span aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span> <b>${category.name}</b>` : '<span style="color:#aaa;">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>';
        document.getElementById('product-price').textContent = product.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : product.price.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('product-description').innerHTML = product.description ? `<span style="white-space:pre-line;">${product.description}</span>` : '<span style="color:#aaa;">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</span>';
        const imageUrl = product.image && product.image !== '' ? getBackendFileUrl('images', product.image) : 'images/placeholder.png';
        document.getElementById('product-image').innerHTML = `<img src="${imageUrl}" alt="img" style="max-width:220px;max-height:220px;border-radius:12px;box-shadow:0 2px 8px #0002;">`;
        // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (category) {
          document.getElementById('back-to-category').innerHTML = `<a href="#" onclick=\"goToPage('category.html?id=${category.id}'); return false;\" style="color:#00916e;text-decoration:underline;font-size:1em;">‚Üê –ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>`;
        }
        // –ö–Ω–æ–ø–∫–∞ –∫—É–ø–∏—Ç—å/—Å–∫–∞—á–∞—Ç—å
        const buyBtn = document.getElementById('buy-btn');
        buyBtn.textContent = product.price === 0 ? '–°–∫–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ' : `–ö—É–ø–∏—Ç—å –∑–∞ ${product.price.toLocaleString()} ‚ÇΩ`;
        document.getElementById('product-file').style.display = product.file ? '' : 'none';
        if (product.file) {
          const fileName = product.file.split('/').pop();
          const ext = fileName.split('.').pop().toLowerCase();
          let icon = '';
          if (["pdf"].includes(ext)) icon = 'üìÑ';
          else if (["zip","rar","7z"].includes(ext)) icon = 'üóúÔ∏è';
          else if (["doc","docx","txt","rtf"].includes(ext)) icon = 'üìù';
          else if (["xls","xlsx","csv"].includes(ext)) icon = 'üìä';
          else if (["png","jpg","jpeg","gif","bmp","webp"].includes(ext)) icon = 'üñºÔ∏è';
          else if (["blend","obj","fbx","stl"].includes(ext)) icon = 'üß©';
          else icon = 'üì¶';
          const fileUrl = getBackendFileUrl('files', fileName);
          document.getElementById('product-file').innerHTML = `<span style="color:#00916e;font-weight:600;">–§–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:</span> <span style="font-size:1.2em;">${icon}</span> <a href="${fileUrl}" target="_blank" style="color:#444;text-decoration:underline;">${fileName}</a> <span id="file-size" style="color:#888;font-size:0.98em;"></span>`;
          // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ HEAD-–∑–∞–ø—Ä–æ—Å
          fetch(fileUrl, { method: 'HEAD' }).then(resp => {
            const size = resp.headers.get('content-length');
            if (size) {
              const kb = (parseInt(size,10)/1024).toFixed(1);
              document.getElementById('file-size').textContent = `(${kb} –ö–ë)`;
            }
          });
        }
        // --- –ò–ó–ë–†–ê–ù–ù–û–ï ---
        const favBlock = document.getElementById('favorite-block');
        favBlock.style.display = '';
        let telegramId = null;
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
          telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
        }
        if (telegramId) {
          // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
          fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/favorites`)
            .then(r=>r.json()).then(favs=>{
              let isFav = favs.some(f=>f.id===product.id);
              renderFav(isFav);
            });
          function renderFav(isFav) {
            favBlock.innerHTML = `<span id="fav-btn" style="font-size:2em;cursor:pointer;user-select:none;transition:color 0.2s;" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</span>`;
            const btn = document.getElementById('fav-btn');
            btn.style.color = isFav ? '#e74c3c' : '#bbb';
            btn.onclick = async function() {
              btn.style.pointerEvents = 'none';
              btn.style.opacity = '0.6';
              if (!isFav) {
                // –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/favorites`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ productId: product.id })
                });
                if (resp.ok) {
                  isFav = true;
                  renderFav(true);
                } else {
                  alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                  renderFav(false);
                }
              } else {
                // –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/favorites/${product.id}`, { method: 'DELETE' });
                if (resp.ok) {
                  isFav = false;
                  renderFav(false);
                } else {
                  alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                  renderFav(true);
                }
              }
              btn.style.pointerEvents = '';
              btn.style.opacity = '';
            }
          }
        } else {
          favBlock.innerHTML = '<span style="color:#bbb;font-size:1.1em;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</span>';
        }
        // --- –ë–ê–õ–ê–ù–° ---
        const balanceBlock = document.getElementById('balance-block');
        balanceBlock.style.display = 'none';
        // telegramId –æ–±—ä—è–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã—à–µ
        async function updateBalance() {
          if (!telegramId) return;
          try {
            const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/balance`);
            const data = await resp.json();
            if (resp.ok) {
              balanceBlock.style.display = '';
              balanceBlock.innerHTML = `<span style='color:#f9b32b;font-weight:600;'>–ë–∞–ª–∞–Ω—Å: </span><span style='color:#222;font-weight:700;'>${data.balance.toLocaleString()} ‚ÇΩ</span> <a href="#" onclick=\"goToPage('account.html'); return false;\" style='margin-left:8px;padding:4px 12px;border-radius:8px;background:#fff;color:#f9b32b;border:1px solid #f9b32b;cursor:pointer;font-size:0.98em;text-decoration:none;'>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>`;
            }
          } catch {}
        }
        if (telegramId) updateBalance();
        // --- –ö–ù–û–ü–ö–ê –ö–£–ü–ò–¢–¨ –ó–ê –ë–ê–õ–ê–ù–° ---
        const buyBalanceBtn = document.getElementById('buy-balance-btn');
        if (product.price > 0 && telegramId) {
          buyBalanceBtn.style.display = '';
          buyBalanceBtn.textContent = `–ö—É–ø–∏—Ç—å –∑–∞ –±–∞–ª–∞–Ω—Å (${product.price.toLocaleString()} ‚ÇΩ)`;
          buyBalanceBtn.onclick = async function() {
            buyBalanceBtn.disabled = true;
            buyBalanceBtn.style.background = '#ffe08a';
            buyBalanceBtn.textContent = '–ü–æ–∫—É–ø–∫–∞...';
            try {
              const resp = await fetch(`https://store-backend-zpkh.onrender.com/account/${telegramId}/buy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: product.id })
              });
              const data = await resp.json();
              if (resp.ok && data.ok) {
                alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –§–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è 7 –¥–Ω–µ–π.');
                updateBalance();
              } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏.');
              }
            } catch (err) {
              alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
            }
            buyBalanceBtn.disabled = false;
            buyBalanceBtn.style.background = '#f9b32b';
            buyBalanceBtn.textContent = `–ö—É–ø–∏—Ç—å –∑–∞ –±–∞–ª–∞–Ω—Å (${product.price.toLocaleString()} ‚ÇΩ)`;
          };
        } else {
          buyBalanceBtn.style.display = 'none';
        }
        buyBtn.onclick = async function() {
          buyBtn.disabled = true;
          buyBtn.style.background = '#43e97b';
          buyBtn.textContent = product.price === 0 ? '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...' : '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞...';
          // –ü–æ–ª—É—á–∞–µ–º Telegram ID —á–µ—Ä–µ–∑ Telegram WebApp API
          let telegramId = null;
          if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
            telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
          } else {
            alert('–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞.');
            buyBtn.disabled = false;
            buyBtn.style.background = '#00916e';
            buyBtn.textContent = product.price === 0 ? '–°–∫–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ' : `–ö—É–ø–∏—Ç—å –∑–∞ ${product.price.toLocaleString()} ‚ÇΩ`;
            return;
          }
          try {
            const resp = await fetch('https://store-backend-zpkh.onrender.com/download', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ telegram_id: telegramId, productId: product.id })
            });
            const data = await resp.json();
            if (resp.ok && data.url) {
              const link = document.createElement('a');
              link.href = data.url;
              link.download = product.file.split('/').pop();
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } else {
              alert(data.error || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.');
            }
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
          }
          buyBtn.disabled = false;
          buyBtn.style.background = '#00916e';
          buyBtn.textContent = product.price === 0 ? '–°–∫–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ' : `–ö—É–ø–∏—Ç—å –∑–∞ ${product.price.toLocaleString()} ‚ÇΩ`;
        };
      } catch (err) {
        showNotFound();
      }
    }
    loadProductAndCategory();

    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
    if (user) {
      // --- –ü—Ä–æ—Ñ–∏–ª—å ---
      const profileLink = document.getElementById('profile-link');
      const profileAvatar = document.getElementById('profile-avatar');
      if (user.photo_url) {
        profileAvatar.innerHTML = `<img src="${user.photo_url}" alt="avatar" style="width:100%;height:100%;object-fit:cover;">`;
      } else {
        let initials = user.first_name ? user.first_name[0] : '';
        if (user.last_name) initials += user.last_name[0];
        profileAvatar.textContent = initials.toUpperCase();
      }
      profileLink.style.display = '';
    }

    function goToPage(url) {
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openTelegramLink) {
        window.Telegram.WebApp.openTelegramLink(url);
      } else {
        window.location.href = url;
      }
    }
  </script>
</body>
</html>
